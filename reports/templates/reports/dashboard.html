{% extends 'base.html' %}
{% load static %}
{% block title %} Сводный отчёт - Commery{% endblock %}
{% block content %}
<div class="container">
    <div class="main_content-wrapper">
        <div class="graphs" id="graphs-bar-wrap" data-report="{{ report.reports_by_week }}">
            <div class="graphs-bar-prewrap">
                <div class="graphs-bar-filter_wrapper">
                    <div class="filter-dropdown_wrapper">
                        <button class="graphs-dropbtn" id="graphs-dropbtn">
                            <img src="{% static 'images/2278049_2.svg' %}" alt="" style="height: 15px; width: 15px;">
                            {% if not current_filter_data %}
                            Период: все время
                            {% else %}
                            Период: пользовательский
                            {% endif %}
                            <img src="{% static 'images/iconizer-32195.svg' %}" alt="" style="height: 8px; width: 8px;">
                        </button>
                        <div class="filter-dropdown_content">
                            <label class="graphs-filter_label">
                                <input
                                        type="checkbox"
                                        checked
                                        class="filter_checkbox"
                                        id="all-checkbox">
                                <span></span>
                                <p>Всё время</p>
                            </label>
                            {% for filter_date in filter_dates_data %}
                            <label class="graphs-filter_label">
                                <input
                                        type="checkbox"
                                        {% if current_filter_data %}
                                        {% for filter_dict in current_filter_data %}
                                        {% if filter_date.year == filter_dict.year and filter_date.week_num in filter_dict.week_nums %}
                                        checked
                                        {% endif %}
                                        {% endfor %}
                                        {% else %}
                                        checked
                                        {% endif %}
                                        class="filter_checkbox"
                                        id="period-checkbox"
                                        data-filter-week="{{ filter_date.week_num }}"
                                        data-filter-year="{{ filter_date.year }}">
                                <span></span>
                                <p>{{ filter_date.week_num }} неделя ({{ filter_date.date_from|date:'d.m.Y'}}-{{filter_date.date_to|date:'d.m.Y'}})</p>
                            </label>
                            {% endfor %}
                            <button type="button" class="apply-graphs-filter_btn">Применить</button>
                        </div>
                    </div>
                </div>
                <div class="graphs-bar-wrap">
                    <div class="graphs-bar">
                        <div class="graphs-bar__bars">
                            <div class="graphs-bar__revenue">
                                <div class="graphs-bar__profit-item-check"></div>
                            </div>
                            <div class="graphs-bar__profit">
                            </div>
                            <!--                            <div class="graphs-bar__tooltip">-->
                            <!--                                <button class="graphs-bar__tooltip-btn">?</button>-->
                            <!--                                <p class="graphs-bar__tooltip-info">-->
                            <!--                                    Короткий текст-->
                            <!--                                </p>-->
                            <!--                            </div>-->
                            <div class="graphs-bar__info">
                                <p class="graphs-bar__info-title">01.01.2023 - 07.01.2023</p>
                                <div class="graphs-bar__info-text">
                                    <p class="graphs-bar__info-string">ПРИБЫЛЬ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">МАРЖИНАЛЬНОСТЬ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">РЕНТАБЕЛЬНОСТЬ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">ПРОДАЖИ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">ВОЗВРАТЫ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">ВЫРУЧКА: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">СЕБЕСТОИМОСТЬ ПРОДАЖ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">КОМИССИЯ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">ЛОГИСТИКА: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">РАСХОДЫ WB: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">ПРОЧИЕ РАСХОДЫ: <span class="graphs-bar__info-span"></span></p>
                                    <p class="graphs-bar__info-string">НАЛОГ: <span class="graphs-bar__info-span"></span></p>
                                </div>
                                <span class="graphs-bar__info-add"></span>
                            </div>
                        </div>

                        <div class="graphs-bar__count">

                        </div>

                        <div class="graphs-bar__legend">
                            <span class="graphs-bar__legend-item">Неделя</span>
                            <span class="graphs-bar__legend-item">Выручка</span>
                            <span class="graphs-bar__legend-item">Прибыль</span>
                        </div>
                    </div>
                </div>

                <div class="graphs-bar-update">
                    <p class="graphs-bar-update__title">Дата обновления отчета <span>{{ current_api_key.last_reports_update|date:'d.m.Y' }}</span></p>
                    <p class="graphs-bar-update__text">Обновить отчет можно на странице <a href="{% url 'reports:report_detail' last_report_date.date|date:'Y-m-d' %}" class="graphs-bar-update__link">"Список отчетов"</a></p>
                </div>
            </div>
            {% if is_unloaded_reports %}
            <div class="invalid_reports-info">
                <img src="{% static 'images/iconizer-4201973.svg' %}" alt="" style="width: 14px; height: 14px;">
                <p class="invalid_reports-text">Часть отчетов не была загружена - Wildberries передает данные частями. Вы сможете загрузить недостающие отчеты на странице <a href="{% url 'reports:report_detail' last_report_date.date|date:'Y-m-d' %}" style="text-decoration: underline">"Список отчётов"</a> через 1 минуту</p>
            </div>
            {% endif %}
            {% if incorrect_reports_ids %}
            <div class="invalid_reports-info">
                <img src="{% static 'images/iconizer-4201973.svg' %}" alt="" style="width: 14px; height: 14px;">
                <p class="invalid_reports-text">В расчетах не учтены отчеты:
                    {% if incorrect_reports_ids|length > 1 %}
                    {% for incorrect_report_id in incorrect_reports_ids %}{{ incorrect_report_id }}, {% endfor %}
                    {% else %}
                    {% for incorrect_report_id in incorrect_reports_ids %}{{ incorrect_report_id }}{% endfor %},
                    {% endif %}
                    данные, получаемые от Wildberries не читаемы. <a href="https://commery.ru/link-to-creators" target="_blank" style="text-decoration: underline">Свяжитесь с нами</a> для решения вопроса</p>
            </div>
            {% endif %}
            <div class="graphs-diog-wrap" id="graphs-diog-wrap" data-brands-share="{{ report.brands_share_in_revenue_dict }}" data-stock-share="{{ report.stocks_share_in_revenue_dict }}">
                <div class="graphs-diog">
                    <p class="graphs-diog__title">ДОЛЯ БРЕНДА В ВЫРУЧКЕ</p>

                    <div class="graphs-diog__wrap">

                        <div class="graphs-canvas-wrap">
                            <canvas class="graphs-diog__item" id="diog-left"></canvas>
                        </div>
                        <div class="graphs-diog__legend" id="graphs-diog__legend-left">
						<span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color1"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color2"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color3"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color4"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color5"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color6"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color7"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color8"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color9"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                        </div>

                    </div>
                </div>

                <div class="graphs-diog">
                    <p class="graphs-diog__title">ДОЛЯ ОТГРУЗОК СО СКЛАДА В ВЫРУЧКЕ</p>


                    <div class="graphs-diog__wrap">
                        <div class="graphs-canvas-wrap">
                            <canvas class="graphs-diog__item" id="diog-right"></canvas>
                        </div>

                        <div class="graphs-diog__legend" id="graphs-diog__legend-right">
						<span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color1"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color2"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color3"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color4"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color5"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color6"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color7"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color8"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>
                            <span class="graphs-diog__legend-text">
							<span class="graphs-diog__legend-color graphs-diog__legend-color9"></span>
							<span class="graphs-diog__legend-text-content"></span>
						</span>

                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="report_block">
            <div class="report_title-block">
                <h1 class="report_title">Нарастающий итог</h1>
                <p class="report_subtitle">Сумма показателей за период</p>
            </div>
            <div class="top_report-block">
                <div class="top_block-item">
                    <div class="top_block-inner">
                        <h1 class="top_block-title">{{ report.revenue_total|floatformat:0|floatformat:"-3g" }}</h1>
                        <p class="top_block-subtitle">Выручка</p>
                    </div>
                    <div class="top_block-inner">
                        <h1 class="top_block-title" style="color: #ff8364;">{{ report.profit_total|floatformat:"-3g" }}</h1>
                        <p class="top_block-subtitle">Прибыль</p>
                    </div>
                </div>
                <div class="top_block-item">
                    <div class="top_block-inner">
                        <h1 class="top_block-title">{{ report.marginality_total }}%</h1>
                        <p class="top_block-subtitle">Маржинальность</p>
                    </div>
                    <div class="top_block-inner">
                        <h1 class="top_block-title">{{ report.profitability_total }}%</h1>
                        <p class="top_block-subtitle">Рентабельность</p>
                    </div>
                </div>
            </div>
            <div class="middle_report-block">
                <div class="middle_block-item">
                    <h1 class="top_block-title">{{ report.sales_amount_total|floatformat:"-3g" }}</h1>
                    <p class="top_block-subtitle">Продажи</p>
                </div>
                <div class="middle_block-item">
                    <h1 class="top_block-title">{{ report.returns_amount_total|floatformat:"-3g" }}</h1>
                    <p class="top_block-subtitle">Возвраты</p>
                </div>
            </div>
            <div class="footer_report-block">
                <div class="footer_block-item">
                    <div class="footer_block-inner">
                        <h1 class="footer_block-title">{{ report.commission_total|floatformat:"-3g" }}</h1>
                        <p class="footer_block-subtitle">Комиссия</p>
                    </div>
                    <div class="footer_block-inner">
                        <h1 class="footer_block-title">{{ report.logistics_total|floatformat:"-3g" }}</h1>
                        <p class="footer_block-subtitle">Логистика</p>
                    </div>
                    <div class="footer_block-inner">
                        <h1 class="footer_block-title">{{ report.wb_costs_total|floatformat:"-3g" }}</h1>
                        <p class="footer_block-subtitle">Расходы вб</p>
                    </div>
                    <div class="footer_block-inner">
                        <div class="left" style="width: 96px;">
                            <h1 class="footer_block-title">{{ report.penalty_total|floatformat:"-3g" }}</h1>
                        </div>
                        <p class="footer_block-subtitle">Штрафы</p>
                    </div>
                </div>
                <div class="footer_block-item">
                    <div class="footer_block-inner">
                        <div class="footer_hint">
                            <div class="left" style="width: 96px;">
                                <h1 class="footer_block-title">{{ report.supplier_costs_total|floatformat:"-3g" }}</h1>
                            </div>
                        </div>
                        <p class="footer_block-subtitle">Расходы поставщика</p>
                    </div>
                    <div class="footer_block-inner">
                        <div class="footer_hint">
                            <div class="left">
                                <h1 class="footer_block-title">{{ report.net_costs_sum_total|floatformat:"-3g" }}</h1>
                            </div>
                        </div>
                        <p class="footer_block-subtitle">СЕБЕСТОИМОСТЬ ПРОДАЖ</p>
                    </div>
                    <div class="footer_block-inner">
                        <div class="footer_hint">
                            <div class="left" style="width: 96px;">
                                <h1 class="footer_block-title">{{ report.tax_total|floatformat:"-3g" }}</h1>
                            </div>
                        </div>
                        <p class="footer_block-subtitle">НАЛОГ</p>
                    </div>
                    <div class="footer_block-inner">
                        <div class="footer_hint">
                            <div class="left" style="width: 96px;">
                                <h1 class="footer_block-title">{{ report.additional_payment_sum_total|floatformat:"-3g" }}</h1>
                            </div>
                        </div>
                        <p class="footer_block-subtitle">Доплаты</p>
                    </div>
                </div>
            </div>
            <div class="errors_list">
                <!--                <div class="error_list_item">-->
                <!--                    <img src="{% static 'images/q_black.svg' %}" alt="" style="width: 14px; height: 14px;"><span-->
                <!--                        style="color: black;">Чтобы считалась чистая прибыль от продаж необходимо отразить расходы по продажам, себестоимость товаров и действующую на момент продаж ставку налога.</span>-->
                <!--                </div>-->
                {% if report.is_empty_reports_values %}
                <div class="error_list_item">
                    <img src="{% static 'images/iconizer-4201973.svg' %}" alt="" style="width: 14px; height: 14px;"><span>Прибыль считается некорректно - на странице "Список отчетов" не заполнены обязательные поля: Стоимость хранения, Стоимость платной приемки и Прочие удержания.</span>
                </div>
                {% endif %}
                {% if report.is_empty_netcosts_values %}
                <div class="error_list_item">
                    <img src="{% static 'images/iconizer-4201973.svg' %}" alt="" style="width: 14px; height: 14px;"><span>Прибыль считается некорректно - на странице "Склад" не указана себестоимость товаров.</span>
                </div>
                {% endif %}
                {% if not report.is_empty_tax_values %}
                <div class="error_list_item">
                    <img src="{% static 'images/iconizer-4201973.svg' %}" alt="" style="width: 14px; height: 14px;"><span>Прибыль считается некорректно - на странице "Настройки - Магазин" не указана ставка налога.</span>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="products_list-block">
            <div class="products_block-filters">
                <div class="plug"></div>
                <div class="products_filter-item">
                    <div class="text-wrapper">
                        <p>Продажи</p>
                    </div>
                    <button type="button" id="sales_sort" onclick="salesSort()"><img src="{% static 'images/ImageToStl.com_4662255 (1).svg' %}" alt=""></button>
                </div>
                <div class="products_filter-item">
                    <div class="text-wrapper">
                        <p>Возвраты</p>
                    </div>
                    <button type="button" id="returns_sort" onclick="returnsSort()"><img src="{% static 'images/ImageToStl.com_4662255 (1).svg' %}" alt=""></button>
                </div>
                <div class="products_filter-item">
                    <div class="text-wrapper">
                        <p>Выручка</p>
                    </div>
                    <button type="button" id="revenue_sort" onclick="revenueSort()"><img src="{% static 'images/ImageToStl.com_4662255 (1).svg' %}" alt=""></button>
                </div>
                <div class="products_filter-item">
                    <div class="text-wrapper">
                        <p>Доля в выручке</p>
                    </div>
                    <button type="button" id="share_sort" onclick="shareSort()"><img src="{% static 'images/ImageToStl.com_4662255 (1).svg' %}" alt=""></button>
                </div>
                <div class="products_filter-item">
                    <div class="text-wrapper">
                        <p>Маржинальность</p>
                    </div>
                    <button type="button" id="marginality_sort" onclick="marginalitySort()"><img src="{% static 'images/ImageToStl.com_4662255 (1).svg' %}" alt=""></button>
                </div>
            </div>
            <div class="products_block" data-title="{{ report_by_products_json }}" id="products_block">
                <!--                <div class="product_wrapper" id="products_wrapper_id">-->
                <!--                    <div class="product_item">-->
                <!--                        <img class="product_img" src="{{ product.image }}" alt="">-->
                <!--                        <div class="text-wrapper">-->
                <!--                            <p class="product_statistic">{{ product.sales_quantity_value|floatformat:"-3g" }}</p>-->
                <!--                        </div>-->
                <!--                        <div class="text-wrapper">-->
                <!--                            <p class="product_statistic">{{ product.returns_quantity_value|floatformat:"-3g" }}</p>-->
                <!--                        </div>-->
                <!--                        <div class="text-wrapper">-->
                <!--                            <p class="product_statistic">{{ product.revenue_by_article|floatformat:"-3g" }}</p>-->
                <!--                        </div>-->
                <!--                        <div class="text-wrapper">-->
                <!--                            <p class="product_statistic">{{ product.share_in_profits }}%</p>-->
                <!--                        </div>-->
                <!--                        <div class="text-wrapper">-->
                <!--                            <p class="product_statistic">{{ product.product_marginality }}%</p>-->
                <!--                        </div>-->
                <!--                    </div>-->
                <!--                    <p class="barcode">Артикул: {{ product.nm_id }}</p>-->
                <!--                </div>-->
            </div>
        </div>
    </div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="{% static 'reports/js/dashboard_products.js' %}"></script>
<script src="{% static 'reports/js/dashboard.js' %}"></script>
<script src="{% static 'reports/js/graphs_filtering.js' %}"></script>
{% endblock %}

